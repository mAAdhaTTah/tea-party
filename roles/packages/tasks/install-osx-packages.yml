---
- name: Install homebrew with geerlingguy.mac.homebrew
  include_role:
    name: geerlingguy.mac.homebrew

- name: Refresh fact after install
  setup:
    filter: ansible_pkg_mgr

- name: Install bash
  community.general.homebrew:
    name: bash
    state: present

- name: Add bash to the allowed shells
  become: true
  lineinfile:
    dest: /etc/shells
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    create: true
    mode: "0644"
  with_items:
    - { regexp: "^{{ homebrew_prefix }}/bin/bash", line: "{{ homebrew_prefix }}/bin/bash" }

- name: Register the current shell
  shell: echo $SHELL
  register: current_shell_result
  changed_when: false
  tags: [skip_ansible_lint]

- name: Change shell for the current user
  become: true
  shell: chsh -s {{ homebrew_prefix }}/bin/bash {{ lookup('env','USER') }}
  when: current_shell_result.stdout != (homebrew_prefix + "/bin/bash")
  changed_when: lookup('env','USER') != "runner"  # fix idempotence in CI
  tags: [skip_ansible_lint]
